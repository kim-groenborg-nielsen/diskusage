name: Auto Tag on merge to main

on:
  push:
    branches:
      - main
      - master

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push next semver tag
        if: github.actor != 'github-actions[bot]'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          # fetch tags
          git fetch --tags

          # ensure the pushed commit is a merge commit (has multiple parents)
          COMMIT=${GITHUB_SHA}
          echo "Checking whether commit $COMMIT is a merge commit"
          PARENTS_LINE=$(git rev-list --parents -n 1 "$COMMIT" || true)
          PARENT_COUNT=$(echo "$PARENTS_LINE" | awk '{print NF-1}')
          echo "Parent count: $PARENT_COUNT"
          if [ "$PARENT_COUNT" -le 1 ]; then
            echo "Not a merge commit (parent count <= 1). Skipping tag creation."
            exit 0
          fi

          # determine latest tag, default v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # strip leading 'v' and split into components
          VER="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VER"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          # bump patch
          PATCH=$((PATCH + 1))
          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Creating new tag: $NEW_TAG"

          # create annotated tag and push using token
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_TAG" -m "chore(release): $NEW_TAG"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" "$NEW_TAG"

          echo "Pushed tag $NEW_TAG"
